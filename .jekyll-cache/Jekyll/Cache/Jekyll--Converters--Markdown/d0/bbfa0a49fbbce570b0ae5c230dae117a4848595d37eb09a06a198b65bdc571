I"zE<p>在调用 win32 库的时候，小伙伴会遇到的问题是不知道对应的 win32 函数应该如何写。或者在网上抄了的代码的实现都有些诡异，想要自己封装发现工作量太大。好消息是官方将 PInvoke 库在 dotnet 基金会完全开源，包含了大量的 Win32 库，如 gdi32.dll 和 kernel32.dll 和 user32.dll 等</p>

<!--more-->

<!-- CreateTime:7/8/2020 9:23:18 AM -->

<p>使用官方的库的优势是什么呢？第一个就是减少从网上复制粘贴有趣的 PInvoke 调用实现，其次是质量上能保底。虽然官方的实现也不够完美，例如 User32 的 GetWindowLong 方法依然有坑。但是因为此项目是在 <a href="https://github.com/dotnet/pinvoke">github 开源</a> 因此也会有大量的小伙伴入坑不断的修复，相对来说应该会比自己实现的好一些</p>

<p>现在官方已经将大量的 dll 进行了封装</p>

<p>已经实现的 dll 如下</p>

<table>
  <thead>
    <tr>
      <th>Library</th>
      <th>Package name</th>
      <th>NuGet</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>advapi32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.AdvApi32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.AdvApi32"><img src="https://buildstats.info/nuget/PInvoke.AdvApi32" alt="NuGet" /></a></td>
      <td>Windows Advanced Services</td>
    </tr>
    <tr>
      <td>bcrypt.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.BCrypt</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.BCrypt"><img src="https://buildstats.info/nuget/PInvoke.BCrypt" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa376210">Windows Cryptography API: Next Generation</a></td>
    </tr>
    <tr>
      <td>cabinet.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Cabinet</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Cabinet"><img src="https://buildstats.info/nuget/PInvoke.Cabinet" alt="NuGet" /></a></td>
      <td><a href="https://docs.microsoft.com/en-us/windows/win32/devnotes/cabinet-api-functions">Cabinet API Functions</a></td>
    </tr>
    <tr>
      <td>cfgmgr32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.CfgMgr32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.CfgMgr32"><img src="https://buildstats.info/nuget/PInvoke.CfgMgr32" alt="NuGet" /></a></td>
      <td><a href="https://docs.microsoft.com/en-us/windows/win32/api/cfgmgr32/">Device and Driver Installation</a></td>
    </tr>
    <tr>
      <td>crypt32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Crypt32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Crypt32"><img src="https://buildstats.info/nuget/PInvoke.Crypt32" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa380256">Windows Cryptography API</a></td>
    </tr>
    <tr>
      <td>DwmApi.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.DwmApi</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.DwmApi"><img src="https://buildstats.info/nuget/PInvoke.DwmApi" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa969540.aspx">Desktop Window Manager</a></td>
    </tr>
    <tr>
      <td>fusion.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Fusion</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Fusion"><img src="https://buildstats.info/nuget/PInvoke.Fusion" alt="NuGet" /></a></td>
      <td>.NET Framework Fusion</td>
    </tr>
    <tr>
      <td>gdi32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Gdi32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Gdi32"><img src="https://buildstats.info/nuget/PInvoke.Gdi32" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/dd145203">Windows Graphics Device Interface</a></td>
    </tr>
    <tr>
      <td>hid.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Hid</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Hid"><img src="https://buildstats.info/nuget/PInvoke.Hid" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff538865">Windows Human Interface Devices</a></td>
    </tr>
    <tr>
      <td>iphlpapi.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.IPHlpApi</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.IPHlpApi"><img src="https://buildstats.info/nuget/PInvoke.IPHlpApi" alt="NuGet" /></a></td>
      <td><a href="IPHlpApi">IP Helper</a></td>
    </tr>
    <tr>
      <td>kernel32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Kernel32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Kernel32"><img src="https://buildstats.info/nuget/PInvoke.Kernel32" alt="NuGet" /></a></td>
      <td>Windows Kernel API</td>
    </tr>
    <tr>
      <td>magnification.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Magnification</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Magnification"><img src="https://buildstats.info/nuget/PInvoke.Magnification" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms692162">Windows Magnification API</a></td>
    </tr>
    <tr>
      <td>mscoree.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.MSCorEE</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.MSCorEE"><img src="https://buildstats.info/nuget/PInvoke.MSCorEE" alt="NuGet" /></a></td>
      <td>.NET Framework CLR host</td>
    </tr>
    <tr>
      <td>msi.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Msi</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Msi"><img src="https://buildstats.info/nuget/PInvoke.Msi" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/aa372860.aspx">Microsoft Installer</a></td>
    </tr>
    <tr>
      <td>ncrypt.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.NCrypt</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.NCrypt"><img src="https://buildstats.info/nuget/PInvoke.NCrypt" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa376210">Windows Cryptography API: Next Generation</a></td>
    </tr>
    <tr>
      <td>netapi32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.NetApi32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.NetApi32"><img src="https://buildstats.info/nuget/PInvoke.NetApi32" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa370680.aspx">Network Management</a></td>
    </tr>
    <tr>
      <td>newdev.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.NewDev</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.NewDev"><img src="https://buildstats.info/nuget/PInvoke.NewDev" alt="NuGet" /></a></td>
      <td><a href="https://docs.microsoft.com/en-us/windows/win32/api/newdev/">Device and Driver Installation</a></td>
    </tr>
    <tr>
      <td>ntdll.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.NTDll</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.NTDll"><img src="https://buildstats.info/nuget/PInvoke.NTDll" alt="NuGet" /></a></td>
      <td>Windows NTDll</td>
    </tr>
    <tr>
      <td>psapi.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Psapi</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Psapi"><img src="https://buildstats.info/nuget/PInvoke.Psapi" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684884.aspx">Windows Process Status API</a></td>
    </tr>
    <tr>
      <td>setupapi.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.SetupApi</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.SetupApi"><img src="https://buildstats.info/nuget/PInvoke.SetupApi" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff550855">Windows setup API</a></td>
    </tr>
    <tr>
      <td>SHCore.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.SHCore</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.SHCore"><img src="https://buildstats.info/nuget/PInvoke.SHCore" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb773177.aspx">Windows Shell</a></td>
    </tr>
    <tr>
      <td>shell32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Shell32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Shell32"><img src="https://buildstats.info/nuget/PInvoke.Shell32" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb773177.aspx">Windows Shell</a></td>
    </tr>
    <tr>
      <td>user32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.User32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.User32"><img src="https://buildstats.info/nuget/PInvoke.User32" alt="NuGet" /></a></td>
      <td>Windows User Interface</td>
    </tr>
    <tr>
      <td>userenv.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.Userenv</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.Userenv"><img src="https://buildstats.info/nuget/PInvoke.Userenv" alt="NuGet" /></a></td>
      <td>Windows User Environment</td>
    </tr>
    <tr>
      <td>uxtheme.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.UxTheme</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.UxTheme"><img src="https://buildstats.info/nuget/PInvoke.UxTheme" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb773187.aspx">Windows Visual Styles</a></td>
    </tr>
    <tr>
      <td>winusb.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.WinUsb</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.WinUsb"><img src="https://buildstats.info/nuget/PInvoke.WinUsb" alt="NuGet" /></a></td>
      <td><a href="https://docs.microsoft.com/en-us/windows/win32/api/winusb/">USB Driver</a></td>
    </tr>
    <tr>
      <td>WtsApi32.dll</td>
      <td><code class="language-plaintext highlighter-rouge">PInvoke.WtsApi32</code></td>
      <td><a href="https://www.nuget.org/packages/PInvoke.WtsApi32"><img src="https://buildstats.info/nuget/PInvoke.WtsApi32" alt="NuGet" /></a></td>
      <td><a href="https://msdn.microsoft.com/en-us/library/aa383468(v=vs.85).aspx">Windows Remote Desktop Services</a></td>
    </tr>
  </tbody>
</table>

<p>那如何使用这个库？在 dotnet 里面使用库都是统一使用 NuGet 的方法，在 NuGet 里面按照自己的需要安装对应的库就可以了</p>

<p>如我想要调用 Kernel32 的 CreateProcess 方法，这个方法里面包含了很多结构体等的实现，如果要我自己去找这些结构体的实现，那么我也许会复制到坑代码。而在使用库的时候，我可以在 csproj 添加下面代码安装 NuGet 库</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">&lt;</span><span class="n">ItemGroup</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="n">PackageReference</span> <span class="n">Include</span><span class="p">=</span><span class="s">"PInvoke.Kernel32"</span> <span class="n">Version</span><span class="p">=</span><span class="s">"0.6.49"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="n">ItemGroup</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>此时我就可以通过 Kernel32 类拿到对应的函数和结构体，请看代码</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">PInvoke</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">startupInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Kernel32</span><span class="p">.</span><span class="nf">STARTUPINFO</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">dwX</span> <span class="p">=</span> <span class="m">300</span><span class="p">,</span> <span class="c1">// X</span>
                <span class="n">dwY</span> <span class="p">=</span> <span class="m">300</span><span class="p">,</span> <span class="c1">// Y</span>
                <span class="n">dwXSize</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span> <span class="c1">// 宽度</span>
                <span class="n">dwYSize</span> <span class="p">=</span> <span class="m">300</span><span class="p">,</span>  <span class="c1">// 高度</span>
                <span class="n">dwFlags</span> <span class="p">=</span> <span class="n">Kernel32</span><span class="p">.</span><span class="n">StartupInfoFlags</span><span class="p">.</span><span class="n">STARTF_USESHOWWINDOW</span><span class="p">,</span>
            <span class="p">};</span>
            
            <span class="n">Kernel32</span><span class="p">.</span><span class="n">PROCESS_INFORMATION</span> <span class="n">processInformation</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">creationFlag</span> <span class="p">=</span> <span class="n">Kernel32</span><span class="p">.</span><span class="n">CreateProcessFlags</span><span class="p">.</span><span class="n">NORMAL_PRIORITY_CLASS</span> <span class="p">|</span> <span class="n">Kernel32</span><span class="p">.</span><span class="n">CreateProcessFlags</span><span class="p">.</span><span class="n">CREATE_UNICODE_ENVIRONMENT</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">processSecurityAttribute</span> <span class="p">=</span> <span class="n">Kernel32</span><span class="p">.</span><span class="n">SECURITY_ATTRIBUTES</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">threadAttribute</span> <span class="p">=</span> <span class="n">Kernel32</span><span class="p">.</span><span class="n">SECURITY_ATTRIBUTES</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

            <span class="n">Kernel32</span><span class="p">.</span><span class="nf">CreateProcess</span>
            <span class="p">(</span>
                <span class="n">lpApplicationName</span><span class="p">:</span> <span class="s">@"C:\windows\notepad.exe"</span><span class="p">,</span>
                <span class="n">lpCommandLine</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span>
                <span class="n">lpProcessAttributes</span><span class="p">:</span> <span class="n">processSecurityAttribute</span><span class="p">,</span>
                <span class="n">lpThreadAttributes</span><span class="p">:</span> <span class="n">threadAttribute</span><span class="p">,</span> 
                <span class="n">bInheritHandles</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span>
                <span class="n">dwCreationFlags</span><span class="p">:</span> <span class="n">creationFlag</span><span class="p">,</span>
                <span class="n">lpEnvironment</span><span class="p">:</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span>
                <span class="n">lpCurrentDirectory</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span>
                <span class="n">lpStartupInfo</span><span class="p">:</span> <span class="k">ref</span> <span class="n">startupInfo</span><span class="p">,</span>
                <span class="n">lpProcessInformation</span><span class="p">:</span> <span class="k">out</span> <span class="n">processInformation</span>
            <span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">Kernel32</span><span class="p">.</span><span class="nf">GetLastError</span><span class="p">());</span>

            <span class="kt">var</span> <span class="n">process</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="nf">GetProcessById</span><span class="p">(</span><span class="n">processInformation</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
</code></pre></div></div>

<p>本文代码放在 <a href="https://github.com/lindexi/lindexi_gd/tree/19cdd72409ba1af6bb3792ce02118055a0948a15/HalwerewolokaichaKojerwhabal">github</a> 欢迎小伙伴访问</p>

:ET
I"<p>默认的 NuGet 包支持在 releaseNotes 中添加更改日志，用户可以通过更改日志了解各个版本更新的内容。在 SDK Style 格式的 csproj 文件，可以读取本地的文本文件的内容作为 NuGet 包的改动日志</p>

<!--more-->

<!-- CreateTime:2020/7/27 10:21:16 -->

<!-- 标签：Roslyn,MSBuild,编译器 -->

<p>在我的团队的 CBB 基础库项目的文件规范，要求每个项目都会包含 README.md 和 CHANGELOG.md 文件，其中的 CHANGELOG.md 文件就是记录 API 变更等的改动记录文件</p>

<p>在更改日志写的比较好的项目是 Office 团队的 <a href="https://github.com/OfficeDev/Open-XML-SDK/blob/5f91dbd7258b9906c265a33172b0b8d988e66f0c/CHANGELOG.md">Open-XML-SDK 项目的 CHANGELOG.md 文件</a> 这个文件记录了每次 PR 包含的更改</p>

<p>在 SDK Style 里面让打包的 NuGet 添加改动日志的方法是设置 PackageReleaseNotes 属性的值，如下面代码</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;PackageReleaseNotes&gt;</span># 1.0

  测试<span class="nt">&lt;/PackageReleaseNotes&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
</code></pre></div></div>

<p>而在项目就包含了 CHANGELOG.md 文件</p>

<p>那么是否可以在 SDK Style 格式的项目文件里面读取项目的 CHANGELOG.md 或 RELEASE-NOTES.txt 的内容，作为 NuGet 包的 ReleaseNotes 内容？可以通过下面几个方法</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;ChangeLogFile&gt;</span>$(MSBuildProjectDirectory)\CHANGELOG.md<span class="nt">&lt;/ChangeLogFile&gt;</span>
    <span class="nt">&lt;PackageReleaseNotes&gt;</span>$([System.IO.File]::ReadAllText($(ChangeLogFile)))<span class="nt">&lt;/PackageReleaseNotes&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
</code></pre></div></div>

<p>上面这个方法将会使用读取文件的方式，将 <code class="language-plaintext highlighter-rouge">ChangeLogFile</code> 的内容读取，然后将文本作为 PackageReleaseNotes 属性的内容。这里需要注意 ChangeLogFile 文件需要使用 Utf-8 编码</p>

<p>上面代码的 <code class="language-plaintext highlighter-rouge">$(MSBuildProjectDirectory)</code> 表示的是 csproj 项目文件所在的文件夹的路径，如果是期望获取当前的文件的文件夹，可以使用 <code class="language-plaintext highlighter-rouge">$(MSBuildThisFileDirectory)</code> 获取当前文件所在的文件夹。上面代码如果写在 csproj 文件，那么 <code class="language-plaintext highlighter-rouge">$(MSBuildThisFileDirectory)</code> 和 <code class="language-plaintext highlighter-rouge">$(MSBuildProjectDirectory)</code> 是相同的</p>

<p>另一个方法不是很靠谱，是通过 Target 读取文件的方式，这个方法不靠谱原因是 GenerateNuspec 不一定触发</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"PreparePackageReleaseNotesFromFile"</span> <span class="na">BeforeTargets=</span><span class="s">"GenerateNuspec"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ReadLinesFromFile</span> <span class="na">File=</span><span class="s">"../RELEASE-NOTES.txt"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">"Lines"</span> <span class="na">ItemName=</span><span class="s">"ReleaseNoteLines"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/ReadLinesFromFile&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;PackageReleaseNotes&gt;</span>@(ReleaseNoteLines, '%0a')<span class="nt">&lt;/PackageReleaseNotes&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="nt">&lt;/Target&gt;</span>
</code></pre></div></div>

<p>上面代码读取 RELEASE-NOTES.txt 文件作为变更日志的内容</p>

<p>详细请看 <a href="https://blog.csdn.net/WPwalter/article/details/80371265">项目文件中的已知 NuGet 属性（使用这些属性，创建 NuGet 包就可以不需要 nuspec 文件啦</a></p>

<p><a href="https://blog.walterlv.com/post/known-properties-in-csproj.html">项目文件中的已知属性（知道了这些，就不会随便在 csproj 中写死常量啦） - walterlv</a></p>

:ET
I"+&<p>插入一个 U 盘的时候，可以在右下角找到安全删除硬件图标，点击就可以删除此硬件。如果此时插入的是一个无线网卡，也就是 USB 无线 wifi 设备，此时如果逗比点了弹出 802.11 设备那么就不能再使用无线上网了
如果我是一个硬件供应商，如何让我的设备不会显示弹出安全删除硬件弹出选项</p>

<!--more-->

<!-- CreateTime:2019/9/25 11:58:19 -->

<!-- csdn -->

<p>我不是做硬件的，对硬件懂的很少，以下是我找到的文档，如果有说错的，欢迎小伙伴告诉我</p>

<p>从 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/install/using-the-usb-removable-capability-for-device-container-grouping">Using the USB Removable Capability for Device Container Grouping</a></p>

<p>可以找到这句话</p>

<blockquote>
  <p>The USB Removable capability allows the operating system to create a device container for legacy devices.</p>
</blockquote>

<p>从 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/install/overview-of-the-removable-device-capability">Overview of the Removable Device Capability</a>可以知道一个 USB 设备是需要声明自己支持 Removable 的才可以在右下角使用安全删除硬件弹出选项</p>

<blockquote>
  <p>The removable device capability is a bit (Removable) that bus drivers set in the DEVICE_CAPABILITIES</p>
</blockquote>

<p>从 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/install/container-ids-generated-from-the-removable-device-capability">Container IDs Generated from the Removable Device Capability</a> 可以知道，在即插即用功能将会使用到这个功能，在设备插入的时候，通过发送 <code class="language-plaintext highlighter-rouge">IRP_MN_QUERY_CAPABILITIES</code> 获取到设备的返回信息，就可以知道这个设备支不支持移除</p>

<blockquote>
  <p>The Plug and Play manager uses the removable device capability to generate a container ID for all devnodes enumerated for the physical device. The bus driver reports the removable device capability in response to an IRP_MN_QUERY_CAPABILITIES request.</p>
</blockquote>

<p>那么上面说的发送信息是什么，就从<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mn-query-capabilities">IRP_MN_QUERY_CAPABILITIES</a> 可以知道，在硬件设备被枚举时，系统的 PnP 也就是即插即用功能将会发送 <code class="language-plaintext highlighter-rouge">IRP_MN_QUERY_CAPABILITIES</code> 信息给到硬件，此时硬件收到时将会回复 <code class="language-plaintext highlighter-rouge">DEVICE_CAPABILITIES</code> 信息</p>

<blockquote>
  <p>When a device is enumerated, but before the function and filter drivers are loaded for the device, the PnP manager sends an IRP_MN_QUERY_CAPABILITIES request to the parent bus driver for the device. The bus driver must set any relevant values in the DEVICE_CAPABILITIES structure and return it to the PnP manager.</p>
</blockquote>

<p>硬件回复的消息请看 <a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/ddi/content/wdm/ns-wdm-_device_capabilities">DEVICE_CAPABILITIES (wdm.h)</a> 在 PnP 询问USB设备，此时USB设备返回 DEVICE_CAPABILITIES 里面可以设置 Removable 项说明此设备支持移除。也就是想要自己的 USB 设备不能被移除，那么就声明不支持移除</p>

<p>以下是 <code class="language-plaintext highlighter-rouge">DEVICE_CAPABILITIES</code> 定义</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">typedef</span> <span class="k">struct</span> <span class="nc">_DEVICE_CAPABILITIES</span> <span class="p">{</span>
  <span class="n">USHORT</span>             <span class="n">Size</span><span class="p">;</span>
  <span class="n">USHORT</span>             <span class="n">Version</span><span class="p">;</span>
  <span class="n">ULONG</span>              <span class="n">DeviceD1</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="n">ULONG</span>              <span class="n">DeviceD2</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="n">ULONG</span>              <span class="n">LockSupported</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="n">ULONG</span>              <span class="n">EjectSupported</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="n">ULONG</span>              <span class="n">Removable</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="c1">// 忽略不相关属性</span>
<span class="p">}</span> <span class="n">DEVICE_CAPABILITIES</span><span class="p">,</span> <span class="p">*</span><span class="n">PDEVICE_CAPABILITIES</span><span class="p">;</span>
</code></pre></div></div>

<p>对 Removable 属性的官方注释是如果设置为 True 那么将会显示弹出或移除设备</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Removable</span>

<span class="n">Specifies</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">device</span> <span class="n">can</span> <span class="n">be</span> <span class="n">dynamically</span> <span class="n">removed</span> <span class="k">from</span> <span class="n">its</span> <span class="n">immediate</span> <span class="n">parent</span><span class="p">.</span> <span class="n">If</span> <span class="n">Removable</span> <span class="k">is</span> <span class="k">set</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">device</span> <span class="n">does</span> <span class="n">not</span> <span class="n">belong</span> <span class="n">to</span> <span class="n">the</span> <span class="n">same</span> <span class="n">physical</span> <span class="kt">object</span> <span class="k">as</span> <span class="n">its</span> <span class="n">parent</span><span class="p">.</span>

<span class="n">For</span> <span class="n">example</span><span class="p">,</span> <span class="k">if</span> <span class="n">Removable</span> <span class="k">is</span> <span class="k">set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">for</span> <span class="n">a</span> <span class="n">USB</span> <span class="n">composite</span> <span class="n">device</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">multifunction</span> <span class="n">printer</span><span class="p">,</span> <span class="n">the</span> <span class="n">composite</span> <span class="n">device</span> <span class="n">does</span> <span class="n">not</span> <span class="n">belong</span> <span class="n">to</span> <span class="n">the</span> <span class="n">physical</span> <span class="kt">object</span> <span class="n">of</span> <span class="n">its</span> <span class="n">immediate</span> <span class="n">parent</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="n">a</span> <span class="n">USB</span> <span class="n">hub</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">notebook</span> <span class="n">PC</span><span class="p">.</span>

<span class="n">In</span> <span class="n">most</span> <span class="n">cases</span> <span class="n">the</span> <span class="n">bus</span> <span class="n">driver</span><span class="p">,</span> <span class="n">not</span> <span class="n">the</span> <span class="n">function</span> <span class="n">driver</span><span class="p">,</span> <span class="n">should</span> <span class="n">determine</span> <span class="n">the</span> <span class="k">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Removable</span> <span class="n">parameter</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span><span class="p">.</span> <span class="n">For</span> <span class="n">USB</span> <span class="n">devices</span><span class="p">,</span> <span class="n">the</span> <span class="n">USB</span> <span class="n">hub</span> <span class="n">driver</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">Removable</span> <span class="n">parameter</span><span class="p">.</span> <span class="n">It</span> <span class="n">should</span> <span class="n">not</span> <span class="n">be</span> <span class="n">modified</span> <span class="k">by</span> <span class="n">the</span> <span class="n">function</span> <span class="n">driver</span><span class="p">.</span>

<span class="n">If</span> <span class="n">Removable</span> <span class="k">is</span> <span class="k">set</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">device</span> <span class="k">is</span> <span class="n">displayed</span> <span class="k">in</span> <span class="n">the</span> <span class="n">Unplug</span> <span class="n">or</span> <span class="n">Eject</span> <span class="n">Hardware</span> <span class="n">program</span><span class="p">,</span> <span class="n">unless</span> <span class="n">SurpriseRemovalOK</span> <span class="k">is</span> <span class="n">also</span> <span class="k">set</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">.</span>
</code></pre></div></div>

<p><a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/install/container-ids-generated-from-a-removable-device-capability-override">从可移动设备功能生成的容器 Id 重写</a></p>

:ET